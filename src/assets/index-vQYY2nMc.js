(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function a(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=a(n);fetch(n.href,r)}})();let f=null,C=null,u=[],c=null,m=1,y=0,I=[],W=1,P=0;const k=document.getElementById("app"),_=document.getElementById("sidebar-toggle"),h=document.getElementById("main-content"),A=document.getElementById("pdfInput"),U=document.getElementById("sealInput");document.getElementById("drop-zone");const J=document.getElementById("upload-pdf-btn-main"),Q=document.getElementById("upload-seal-btn"),S=document.getElementById("seal-preview"),ee=document.getElementById("seal-placeholder"),j=document.getElementById("thumbnail-container"),te=document.getElementById("addSeal"),ne=document.getElementById("addStraddle"),ae=document.getElementById("deleteSeal"),oe=document.getElementById("exportPDF"),re=document.getElementById("zoom-slider"),ie=document.getElementById("zoom-value"),le=document.getElementById("page-indicator"),B=document.getElementById("page-selector"),$=document.getElementById("rotation-slider"),H=document.getElementById("rotation-input");async function se(){pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist/build/pdf.worker.min.js",ce(),console.log("应用已初始化")}function ce(){_.addEventListener("click",()=>{k.classList.toggle("sidebar-collapsed"),I=new Array(y).fill(null),setTimeout(()=>{f&&D(m,!0)},300)}),h.addEventListener("dragover",e=>{e.preventDefault(),h.classList.add("dragover")}),h.addEventListener("dragleave",()=>h.classList.remove("dragover")),h.addEventListener("drop",e=>{e.preventDefault(),h.classList.remove("dragover");const t=e.dataTransfer.files;t.length>0&&t[0].type==="application/pdf"&&T(t[0])}),J.addEventListener("click",()=>A.click()),A.addEventListener("change",e=>e.target.files.length>0&&T(e.target.files[0])),Q.addEventListener("click",()=>U.click()),U.addEventListener("change",e=>e.target.files.length>0&&ue(e.target.files[0])),te.addEventListener("click",pe),ae.addEventListener("click",M),ne.addEventListener("click",fe),oe.addEventListener("click",me),B.addEventListener("change",e=>{const t=parseInt(e.target.value,10);t!==m&&D(t)}),re.addEventListener("input",e=>{W=parseFloat(e.target.value),z()}),$.addEventListener("input",e=>{const t=parseInt(e.target.value,10);H.value=t,P=t,S.style.transform=`rotate(${t}deg)`}),H.addEventListener("input",e=>{const t=parseInt(e.target.value,10);!isNaN(t)&&t>=-180&&t<=180&&($.value=t,P=t,S.style.transform=`rotate(${t}deg)`)}),window.addEventListener("keydown",e=>{(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),M())})}function z(){if(!f)return;ie.textContent=`${Math.round(W*100)}% (Fit-Width)`;const e=u[m-1];if(e){const a=I[m-1]*W;e.setZoom(a),e.setDimensions({width:e.originalWidth*a,height:e.originalHeight*a}),e.renderAll()}}function de(){le.textContent=`第 ${m} / ${y} 页`,B.innerHTML="";for(let e=1;e<=y;e++){const t=document.createElement("option");t.value=e,t.textContent=`第 ${e} 页`,B.appendChild(t)}B.value=m}function X(e,t){const a=document.createElement("canvas"),o=a.getContext("2d"),n=e.width,r=e.height,i=Math.sqrt(n*n+r*r);a.width=i,a.height=i,o.translate(i/2,i/2),o.rotate(t*Math.PI/180),o.drawImage(e,-n/2,-r/2);const l=document.createElement("canvas");return l.width=n,l.height=r,l.getContext("2d").drawImage(a,(i-n)/2,(i-r)/2,n,r,0,0,n,r),l.toDataURL()}async function T(e){k.classList.remove("no-pdf-loaded"),j.innerHTML="<p>渲染中...</p>",h.innerHTML="";const t=new FileReader;t.onload=async a=>{C=new Uint8Array(a.target.result);try{f=await pdfjsLib.getDocument({data:C.slice()}).promise,y=f.numPages,u=new Array(y).fill(null),I=new Array(y).fill(null),await ge()}catch(o){console.error("加载PDF失败:",o),alert("PDF加载失败，请检查文件。"),k.classList.add("no-pdf-loaded")}},t.readAsArrayBuffer(e)}async function ge(){j.innerHTML="",m=1;for(let e=1;e<=y;e++){const t=document.createElement("div");t.className="thumbnail-item",t.dataset.pageNumber=e;const a=document.createElement("canvas");t.appendChild(a);const o=document.createElement("p");o.textContent=`第 ${e} 页`,t.appendChild(o),j.appendChild(t);const n=await f.getPage(e),r=n.getViewport({scale:.3});a.height=r.height,a.width=r.width,await n.render({canvasContext:a.getContext("2d"),viewport:r}).promise,t.addEventListener("click",()=>D(e));const i=document.createElement("div");i.id=`page-wrapper-${e}`,i.className="canvas-wrapper",i.style.display="none";const l=document.createElement("canvas");l.id=`canvas-${e}`,i.appendChild(l),h.appendChild(i)}await D(1)}async function G(e,t=!1){if(t||!I[e-1]){const w=(await f.getPage(e)).getViewport({scale:2}),p=h.clientWidth-40;I[e-1]=p*.9/w.width}if(u[e-1]&&!t)return u[e-1];const a=await f.getPage(e),o=a.getViewport({scale:2}),n=o.width,r=o.height,i=document.getElementById(`canvas-${e}`),l=u[e-1]||new fabric.Canvas(i);if(!u[e-1]){l.originalWidth=n,l.originalHeight=r;const s=document.createElement("canvas");s.width=n,s.height=r,await a.render({canvasContext:s.getContext("2d"),viewport:o}).promise,l.setBackgroundImage(new fabric.Image(s),l.renderAll.bind(l)),u[e-1]=l}return l}async function D(e,t=!1){if(!f)return;m=e,document.querySelectorAll(".canvas-wrapper").forEach(n=>n.style.display="none"),document.querySelectorAll(".thumbnail-item").forEach(n=>n.classList.remove("active"));const a=document.querySelector(`.thumbnail-item[data-page-number="${e}"]`);a&&a.classList.add("active");const o=document.getElementById(`page-wrapper-${e}`);o.style.display="block",await G(e,t),z(),de()}function ue(e){const t=new FileReader;t.onload=function(a){const o=a.target.result;c=new Image,c.src=o,S.src=o,S.classList.remove("hidden"),ee.classList.add("hidden"),c.onload=()=>{alert("印章已准备好。")}},t.readAsDataURL(e)}function pe(){if(!c||!c.src||c.naturalWidth===0||!f){alert("请先选择一个有效的印章图片！");return}const e=u[m-1];if(!e)return;const t=new Image;t.onload=()=>{const a=X(t,P);fabric.Image.fromURL(a,o=>{o.scaleToWidth(e.originalWidth/5),o.set({left:e.originalWidth/2,top:e.originalHeight/2,originX:"center",originY:"center",cornerSize:10,cornerStyle:"circle",cornerColor:"#007bff",transparentCorners:!1,borderColor:"#007bff",lockRotation:!0,angle:0}),e.add(o),e.setActiveObject(o),e.renderAll()})},t.onerror=()=>{alert("无法处理此印章图片。")},t.src=c.src}async function fe(){if(!c||!c.src||c.naturalWidth===0||!f){alert("请先选择一个有效的印章图片！");return}const e=new Image;e.onload=async()=>{const t=X(e,P),a=new Image;a.src=t,a.onload=async()=>{const o=f.numPages,n=c.width/o,r=`straddle-${Date.now()}`;for(let i=0;i<o;i++){const l=i+1,s=await G(l);if(!s)continue;const w=s.originalWidth/5/c.width,p=document.createElement("canvas");p.width=n,p.height=c.height,p.getContext("2d").drawImage(a,i*n,0,n,c.height,0,0,n,c.height),fabric.Image.fromURL(p.toDataURL(),d=>{d.scale(w);const L=n*w;d.set({left:s.originalWidth-L,top:400,hasControls:!0,borderColor:"#007bff",lockMovementX:!0,lockRotation:!0,straddleGroup:r,pageIndex:i,originX:"left",originY:"top",angle:0}),s.add(d),s.renderAll();const E=v=>{u.forEach(b=>{b&&b.getObjects().filter(g=>g.straddleGroup===r&&g!==v).forEach(g=>{g.set({top:v.top,scaleX:v.scaleX,scaleY:v.scaleY}).setCoords(),b.renderAll()})})};d.on("moving",()=>E(d)),d.on("scaling",()=>E(d))})}}},e.onerror=()=>{alert("无法处理此印章图片。")},e.src=c.src}function M(){const e=u[m-1];if(!e)return;const t=e.getActiveObject();if(t&&confirm("确定要删除选中的印章吗？"))if(t.straddleGroup){const a=t.straddleGroup;u.forEach(o=>{o&&(o.getObjects().filter(n=>n.straddleGroup===a).forEach(n=>o.remove(n)),o.renderAll())})}else e.remove(t),e.renderAll()}async function me(){var t;if(!C)return alert("请先上传PDF文件！");const e=document.getElementById("exportPDF");e.textContent="导出中...",e.disabled=!0;try{const{PDFDocument:a,degrees:o}=window.PDFLib,n=await a.load(C),r=n.getPages();for(let p=0;p<r.length;p++){const d=u[p];if(!d)continue;const L=r[p],{width:E,height:v}=L.getSize(),b=d.getObjects().filter(g=>!g.isBackgroundImage);for(const g of b){const V=g.toDataURL({format:"png",multiplier:2}),Y=await fetch(V).then(N=>N.arrayBuffer()),q=await n.embedPng(Y),F=g.getScaledWidth(),x=g.getScaledHeight();let R=g.left,O=g.top;g.originX==="center"&&(R-=F/2),g.originY==="center"&&(O-=x/2);const Z=R/d.originalWidth*E,K=v-(O+x)/d.originalHeight*v;L.drawImage(q,{x:Z,y:K,width:F/d.originalWidth*E,height:x/d.originalHeight*v,rotate:o(0)})}}const i=await n.save(),l=new Blob([i],{type:"application/pdf"}),s=document.createElement("a");s.href=URL.createObjectURL(l);const w=((t=A.files[0])==null?void 0:t.name.replace(".pdf",""))||"document";s.download=`${w}_盖章版.pdf`,s.click(),URL.revokeObjectURL(s.href)}catch(a){console.error("导出PDF时发生错误:",a),alert("导出失败，详情请查看控制台。")}finally{e.textContent="导出为 PDF",e.disabled=!1}}se();
